name: NightlyBuildWeekly

on:
  schedule:
    - cron: '0 0 * * 1'  # æ¯å‘¨ä¸€ 00:00 UTC æ‰§è¡Œ
  workflow_dispatch:

jobs:
  Release:
    runs-on: ubuntu-latest
    if: github.repository == 'LIPiston/rime-ice'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pack dicts
        run: |
          ## å¤‡ç”¨ Prepare opencc dict, å¯ç”¨å emoji.json ä¹Ÿè¦åšæ”¹åŠ¨
          # apt install opencc
          # opencc_dict -i opencc/emoji.txt -o opencc/emoji.ocd2 -f text -t ocd2

          mkdir dist
          echo "Pack all ..."
          find . -maxdepth 1 -name "*.lua" -o -name "*.yaml" -o -name "*.txt" | zip dist/full.zip -@
          zip -r dist/full.zip cn_dicts cn_dicts_cell en_dicts lua opencc LICENSE
          echo "Pack dicts ..."
          zip -r dist/all_dicts.zip cn_dicts en_dicts opencc radical_pinyin.dict.yaml
          echo "Pack cn_dicts ..."
          zip -r dist/cn_dicts.zip cn_dicts
          echo "Pack en_dicts ..."
          zip -r dist/en_dicts.zip en_dicts
          echo "Pack opencc ..."
          zip -r dist/opencc.zip opencc
          echo "copy LICENSE and README.md..."
          cp LICENSE dist/LICENSE.txt
          cp README.md dist/README.md

      - name: Get current time (UTC+8)
        id: time
        run: |
          export TZ='Asia/Shanghai'
          echo "time=$(date +'%Y-%m-%d %H:%M:%S UTC+8')" >> $GITHUB_OUTPUT

            - name: Delete existing nightly release
              if: ${{ github.ref == 'refs/heads/main' }}
              env:
                GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                gh release delete nightly -y || echo "No existing nightly release to delete"

      - name: Create nightly release
        if: ${{ github.ref == 'refs/heads/main' }}
        uses: "softprops/action-gh-release@v2"
        with:
          body: |
            ## è¯´æ˜

            è¿™é‡Œæ˜¯æ¯æ¬¡æäº¤åè‡ªåŠ¨æ‰“åŒ…çš„ç‰ˆæœ¬ï¼ŒåŒ…å«æœ€æ–°çš„åŠŸèƒ½å’Œè¯åº“
            ğŸ“… æ„å»ºæ—¶é—´ï¼š${{ steps.time.outputs.time }}

            - `README.md`ï¼šç®€æ˜“çš„ä½¿ç”¨è¯´æ˜
            - `full.zip` : åŒ…å«æ‰€æœ‰è¯å…¸å’Œæ–¹æ¡ˆæ–‡ä»¶
            - `cn_dicts.zip`ï¼šä¸­æ–‡è¯åº“
            - `en_dicts.zip`ï¼šè‹±æ–‡è¯åº“
            - `opencc.zip`ï¼šopencc è¯åº“ï¼ˆemoji ç­‰ï¼‰
            - `all_dicts.zip`ï¼šä»¥ä¸Šå››ä¸ªè¯åº“çš„æ•´åˆ
            - `LICENSE.txt`ï¼šå¼€æºåè®®

          tag_name: nightly
          name: "nightly build"
          make_latest: true
          files: |
            dist/*
